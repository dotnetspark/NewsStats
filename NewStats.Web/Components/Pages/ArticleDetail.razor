@page "/article/{ArticleId}"
@using NewStats.Web.Models
@using NewStats.Web.Services
@inject RedisCacheService CacheService
@inject SessionMetricsService MetricsService
@inject NavigationManager NavigationManager

<PageTitle>@(article?.Title ?? "Article") - NewStats</PageTitle>

<div class="container mx-auto px-4 py-8">
    <button @onclick="GoBack" class="mb-6 flex items-center text-blue-600 hover:text-blue-800 transition-colors">
        <span class="mr-2">‚Üê</span>
        <span>Back to search</span>
    </button>

    @if (isLoading)
    {
        <div class="flex justify-center items-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>
    }
    else if (article == null)
    {
        <div class="text-center py-12">
            <div class="text-6xl mb-4">üòï</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Article not found</h2>
            <p class="text-gray-600 mb-4">The article you're looking for doesn't exist or has been removed.</p>
            <button @onclick="GoBack" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                Return to search
            </button>
        </div>
    }
    else
    {
        <article class="max-w-4xl mx-auto">
            <header class="mb-8">
                <div class="flex items-center gap-4 mb-4 text-sm text-gray-600">
                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-semibold">@article.Source</span>
                    <span>@article.PublishedAt.ToString("MMMM dd, yyyy 'at' h:mm tt")</span>
                    @if (!string.IsNullOrEmpty(article.Author) && article.Author != "Unknown")
                    {
                        <span>by <strong>@article.Author</strong></span>
                    }
                </div>
                <h1 class="text-4xl font-bold text-gray-900 mb-4 leading-tight">@article.Title</h1>
                <p class="text-xl text-gray-600 leading-relaxed">@article.Description</p>
            </header>

            @if (!string.IsNullOrEmpty(article.UrlToImage))
            {
                <div class="mb-8 rounded-xl overflow-hidden shadow-lg">
                    <img src="@article.UrlToImage" alt="@article.Title" class="w-full h-auto"
                         onerror="this.parentElement.style.display='none'" />
                </div>
            }

            <div class="prose prose-lg max-w-none mb-8">
                <p class="text-gray-700 leading-relaxed text-lg">@article.Content</p>
            </div>

            <div class="border-t border-gray-200 pt-6">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div class="flex items-center gap-4">
                        <span class="text-gray-600">
                            üëÅÔ∏è Viewed @clickCount time(s) this session
                        </span>
                    </div>
                    @if (!string.IsNullOrEmpty(article.Url) && article.Url != "#")
                    {
                        <a href="@article.Url" target="_blank" rel="noopener noreferrer"
                           class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            Read full article
                            <span class="ml-2">‚Üó</span>
                        </a>
                    }
                </div>
            </div>
        </article>
    }
</div>

@code {
    [Parameter]
    public string? ArticleId { get; set; }

    private Article? article;
    private bool isLoading = true;
    private int clickCount = 0;

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(ArticleId))
        {
            isLoading = false;
            return;
        }

        article = await CacheService.GetArticleAsync(ArticleId);
        clickCount = MetricsService.GetClickCount(ArticleId);
        isLoading = false;
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/");
    }
}
